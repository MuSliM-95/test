## Схема CI/CD
Данная схема предполагает наличие двух защищенных (стабильных) веток:
*   `master`: Основная ветка, используется для развертывания в **Production** окружении.
*   `dev`: Ветка для разработки, используется для развертывания в **Dev/Staging** окружении.

### Управление Тестами

*   **Переменная `SKIP_TEST`:** Глобальная переменная, по умолчанию установлена в `"false"`.
*   **Действие:** Шаги тестирования и линтинга (см. таблицу) **будут запущены** только при условии, что `$SKIP_TEST` не равен `"true"`.
*   **Пропуск:** Если `$SKIP_TEST` явно установлен в `"true"`, соответствующие шаги будут пропущены.

### Шаги CI/CD

| Шаг (Job) | Когда запускается | Примечание (Что проверяется/Развертывание) |
| :--- | :--- | :--- |
| `lint-backend` | На всех ветках и Merge Requests, если `$SKIP_TEST` не равен `"true"` | Проверка стиля и форматирования **всего кода** `backend` (с помощью инструментов Ruff и Black). |
| `smoke-test-job` | На всех ветках и Merge Requests, если `$SKIP_TEST` не равен `"true"` | Развертывание тестового окружения (Docker Compose) и верификация базовой работоспособности **backend** через HTTP Health Check (`/health`). |
| `build-up-docker-job-dev` | При коммите в защищенную ветку `dev` | Сборка и развертывание в **Dev/Staging** окружении. |
| `build-up-docker-job` | При коммите в защищенную ветку `master` | Сборка и развертывание в **Production** окружении. |

---

### Описание Шагов (Jobs)

#### `lint-backend`
Проверяет код в директории `backend`. Использует **Ruff** для статического анализа и линтинга, и **Black** для проверки форматирования. Обеспечивает соответствие всего исходного кода в `backend` установленным стандартам кодирования и стилю.

#### `smoke-test-job`
Выполняет минимальное функциональное тестирование (smoke tests). Поднимает тестовое окружение с помощью Docker Compose, ждет запуска сервисов и выполняет **HTTP Health Check** к эндпоинту `/health` сервиса `backend_test` для подтверждения его работоспособности. Скрипт завершает работу, удаляя окружение и сохраняя полные логи Docker в артефакты.

#### `build-up-docker-job-dev`
Отвечает за развертывание в **Dev/Staging** окружении.
1.  Устанавливает необходимые переменные окружения.
2.  Собирает Docker-образы (на основе конфигурации в `.deploy/docker-compose.dev-server.yml`).
3.  Останавливает старые контейнеры (`docker compose down`).
4.  Запускает обновленные сервисы (`docker compose up -d --force-recreate`).

#### `build-up-docker-job`
Отвечает за развертывание в **Production** окружении.
1.  Осуществляет вход в Docker Registry.
2.  Собирает Docker-образы (`backend` и `nginx`).
3.  Помечает собранные образы тегами, включающими `$CI_COMMIT_SHA`, и отправляет их в Registry.
4.  Запускает скрипт `.deploy/deploy.sh` для фактического деплоя на производственном сервере.
